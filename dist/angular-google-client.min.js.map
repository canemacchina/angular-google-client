{"version":3,"sources":["googleApi.module.js","google-client.provider.js","google-client.service.js","google-picker.directive.js"],"names":["angular","module","provider","clientId","apiLoadingPromise","scriptsLoadingPromise","scopes","apisToLoad","scriptsToLoad","googleApis","cloudEndpoints","tryAutomaticAuth","loadClient","loadPicker","apiLoaded","apiLoading","scriptsLoaded","scriptsLoading","apiLoadCallback","gapi","auth","authorize","client_id","scope","immediate","resolve","scriptsLoadCallback","loadScripts","aScriptLoaded","load","callback","reject","loadApi","anApiLoaded","forEach","endpoint","client","api","version","baseUrl","loadClientLibrary","this","loadPickerLibrary","addApi","obj","push","setAutomaticAuth","addScope","setClientId","$get","$q","$window","$document","afterScriptsLoaded","defer","_cmGoogleClientInitCallback","script","createElement","onerror","e","src","body","appendChild","promise","afterApiLoaded","then","service","googleClient","execute","apiMethod","params","deferred","split","method","m","request","resp","reason","directive","loading","authDeferred","oauthToken","restrict","locale","views","onPicked","link","element","attrs","authUser","handleAuthResult","authResult","error","access_token","pickerCallback","data","action","google","picker","Action","PICKED","docs","openPicker","PickerBuilder","setLocale","setOAuthToken","setOrigin","location","protocol","host","setCallback","viewArray","view","addView","build","setVisible","bind"],"mappings":"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","file":"angular-google-client.min.js","sourcesContent":["(function() {\n  'use strict';\n  angular.module('cm-google-api', []);\n})();\n","(function() {\n  'use strict';\n  angular.module('cm-google-api').provider('googleClient', function () {\n    var clientId;\n    var scopes = [];\n\n    var apisToLoad = 0;\n    var scriptsToLoad = 0;\n    var googleApis = [];\n    var cloudEndpoints = [];\n    var tryAutomaticAuth = false;\n    var loadClient = false;\n    var loadPicker = false;\n\n    var apiLoadingPromise;\n    var apiLoaded = false;\n    var apiLoading = false;\n\n    var scriptsLoadingPromise;\n    var scriptsLoaded = false;\n    var scriptsLoading = false;\n\n    var apiLoadCallback = function() {\n      if (--apisToLoad === 0) {\n        apiLoaded = true;\n        apiLoading = false;\n        if(tryAutomaticAuth){\n          gapi.auth.authorize({'client_id': clientId, 'scope': scopes, 'immediate': true}, function(){apiLoadingPromise.resolve();});\n        }else{\n          apiLoadingPromise.resolve();\n        }\n      }\n    };\n\n    var scriptsLoadCallback = function() {\n      if (--scriptsToLoad === 0) {\n        scriptsLoaded = true;\n        scriptsLoading = false;\n        scriptsLoadingPromise.resolve();\n      }\n    };\n\n    var loadScripts = function(){\n      var aScriptLoaded = false;\n      if(loadClient){\n        aScriptLoaded = true;\n        gapi.load('client', {'callback': scriptsLoadCallback});\n      }\n      if(loadPicker){\n        if(typeof clientId === 'undefined'){\n          scriptsLoadingPromise.reject('you need to provide the clientId if you load Picker script');\n        }else{\n          aScriptLoaded = true;\n          gapi.load('picker', {'callback': scriptsLoadCallback});\n          gapi.load('auth', {'callback': scriptsLoadCallback});\n        }\n      }\n      return aScriptLoaded;\n    };\n\n    var loadApi = function(){\n      var anApiLoaded = false;\n      angular.forEach(cloudEndpoints, function(endpoint){\n        anApiLoaded = true;\n        gapi.client.load(endpoint.api, endpoint.version, apiLoadCallback, endpoint.baseUrl);\n      });\n      angular.forEach(googleApis, function(api){\n        anApiLoaded = true;\n        gapi.client.load(api.api, api.version, apiLoadCallback);\n      });\n      return !loadClient || anApiLoaded;\n    };\n\n    var loadClientLibrary = function(){\n      if(!loadClient){\n        loadClient = true;\n        scriptsToLoad++;\n      }\n      return this;\n    };\n\n    this.loadPickerLibrary = function(){\n      if(!loadPicker){\n        loadPicker = true;\n        //just a bit weird. If I load picker library, I need to call\n        //gapi.load('auth', {'callback': scriptsLoadCallback});\n        //but if I load client library, auth is automatically loaded.\n        //Instead of handle both cases, I prefer to load two time auth\n        scriptsToLoad +=2;\n      }\n      return this;\n    };\n\n    this.addApi = function(api, version, baseUrl){\n      loadClientLibrary();\n      var obj = {};\n      obj.api = api;\n      obj.version = version;\n      apisToLoad++;\n      if(typeof baseUrl === 'undefined'){\n        googleApis.push(obj);\n      }else{\n        obj.baseUrl = baseUrl;\n        cloudEndpoints.push(obj);\n      }\n      return this;\n    };\n\n    this.setAutomaticAuth = function(){\n      tryAutomaticAuth = true;\n      this.addScope('https://www.googleapis.com/auth/userinfo.email');\n      return this;\n    };\n\n    this.addScope = function(scope){\n      scopes += ' ' + scope;\n      return this;\n    };\n\n    this.setClientId = function(client){\n      clientId = client;\n      return this;\n    };\n\n    this.$get = ['$q', '$window', '$document', function ($q, $window, $document) {\n      return{\n        afterScriptsLoaded: function(){\n          if(!scriptsLoaded && !scriptsLoading){\n            scriptsLoading = true;\n            scriptsLoadingPromise = $q.defer();\n            $window._cmGoogleClientInitCallback = function(){\n              if(!loadScripts()){\n                scriptsLoadingPromise.reject('at least you need to add some api or load picker.js');\n              }\n            };\n            var script = $document[0].createElement('script');\n            script.onerror = function (e) {\n              scriptsLoadingPromise.reject(e);\n            };\n            script.src = 'https://apis.google.com/js/api.js?onload=_cmGoogleClientInitCallback';\n            $document[0].body.appendChild(script);\n          }\n          return scriptsLoadingPromise.promise;\n        },\n        afterApiLoaded: function(){\n          if(!apiLoaded && !apiLoading){\n            apiLoadingPromise = $q.defer();\n            apiLoading = true;\n            this.afterScriptsLoaded().then(function(){\n              if(!loadApi()){\n                apiLoadingPromise.reject('at least you nedd to load an Api');\n              }\n            },\n            function(e){\n              apiLoadingPromise.reject(e);\n            });\n          }\n          return apiLoadingPromise.promise;\n        },\n        clientId: clientId,\n        scopes: scopes\n      };\n    }];\n  });\n})();\n","(function() {\n  'use strict';\n  angular.module('cm-google-api').service('googleClientService', ['$q', 'googleClient', function ($q, googleClient) {\n    this.execute = function(apiMethod, params){\n      var deferred = $q.defer();\n      googleClient.afterApiLoaded().then(function(){\n        apiMethod = apiMethod.split('.');\n        var method = gapi.client;\n        angular.forEach(apiMethod, function(m){\n          method = method[m];\n        }, method);\n        var request;\n        if(typeof params === 'undefined'){\n          request = method();\n        }else{\n          request = method(params);\n        }\n        request.then(\n          function(resp){\n            deferred.resolve(resp);\n          },\n          function(reason){\n            deferred.reject(reason);\n          });\n      },\n      function(e){\n        deferred.reject(e);\n      });\n      return deferred.promise;\n    };\n  }]);\n})();\n","(function() {\n  'use strict';\n  angular.module('cm-google-api').directive('cmGooglePicker', ['googleClient', '$q', '$window', function(googleClient, $q, $window){\n    var loading;\n    var authDeferred;\n    var oauthToken = null;\n    return {\n     restrict: 'A',\n     scope: {\n      scopes: '=',\n      locale: '@',\n      views: '&',\n      onPicked: '='\n    },\n    link: function (scope, element, attrs) {\n      function authUser() {\n        if(!loading && !oauthToken){\n          authDeferred = $q.defer();\n          gapi.auth.authorize( { 'client_id': googleClient.clientId, 'scope': scope.scopes, 'immediate': false },  handleAuthResult);\n        }\n        return authDeferred.promise;\n      }\n\n      function handleAuthResult(authResult) {\n        loading = false;\n        if (authResult && !authResult.error) {\n          oauthToken = authResult.access_token;\n          authDeferred.resolve();\n        }else{\n          authDeferred.reject();\n        }\n      }\n\n      function pickerCallback (data) {\n        if (scope.onPicked && data.action === google.picker.Action.PICKED) {\n          scope.onPicked(data.docs);\n        }\n      }\n\n      function openPicker(){\n        googleClient.afterScriptsLoaded().then(\n          function(){\n            authUser().then(function(){\n              var picker = new google.picker.PickerBuilder()\n              .setLocale(scope.locale)\n              .setOAuthToken(oauthToken)\n              .setOrigin($window.location.protocol + '//' + $window.location.host)\n              .setCallback(pickerCallback);\n              var viewArray = scope.views();\n              angular.forEach(viewArray, function(view){\n                picker.addView(view);\n              });\n              picker = picker.build();\n              picker.setVisible(true);\n            });\n          }\n        );\n      }\n\n      loading = true;\n      googleClient.afterScriptsLoaded().then(\n        function(){\n          authDeferred = $q.defer();\n          gapi.auth.authorize( { 'client_id': googleClient.clientId, 'scope': scope.scopes, 'immediate': true },  handleAuthResult);\n        }\n      );\n\n      element.bind('click', function (e) {\n        openPicker();\n      });\n    }\n  };\n}]);\n})();\n"],"sourceRoot":"/source/"}